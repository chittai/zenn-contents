---
title: "Amazon Q Developer CLIのカスタムエージェントでAWS運用を自動化する"
emoji: "🤖"
type: "tech"
topics: ["AWS", "AmazonQ", "IAM", "自動化"]
published: false
---

AWS環境の運用において、IAM Identity Centerのユーザー管理や権限付与は定期的に発生する作業かと思います。弊社でもSRE/インフラチームが依頼を受け作業を行います。依頼を受けてから自動承認をするような仕組みがあるのですが、あまり頻度が高くないことからこれを運用し続けることって逆にコストの方が大きくならないか？と思うこともあります。
でも、作業を完了させるには適切なアカウントへのアクセス、権限セットの確認、操作の実行など、多くの手順を踏む必要があります。それは地味にめんどくさいです。そこで、Amazon Q Developer CLIをつかってやろうとしたのですが、それでもも以下の課題がありました。

- 対象の環境へアクセスするためにAIと会話のラリーが必要（めんどくさい）
- どのプロファイルを使うべきか判断できないため、指定が必要（めんどくさい）
- Jiraに書かれた依頼内容を正確に読み取ってくれるわけではないため都度指示が必要（めんどくさい）

これらの問題により、せっかくAIに依頼しても、途中で手動介入が必要になり、効率化の効果が半減していました。

ということで、Amazon Q Developer の **カスタムエージェント機能** を活用して、これらの課題を解決し、AWS運用業務を効率化する方法を紹介します。

## カスタムエージェントとは
カスタムエージェントについて簡単に紹介します。Amazon Q Developer CLIにログインするとデフォルトエージェントとして動作します。汎用的なタスクにはよいのですが今回のようにやることがわかっていて期待値も明確であるた場合はその目的に合わせたチューニングしたエージェントを用意できます。これがカスタムエージェントです。

https://docs.aws.amazon.com/ja_jp/amazonq/latest/qdeveloper-ug/command-line-custom-agents.html

カスタムエージェントは、特定の業務に特化したAIアシスタントを作成できる機能です。以下の要素で構成されます：

- **プロンプト**: エージェントの役割と振る舞いを定義
- **リソース**: 参照すべきドキュメントやルール
- **ツール**: 使用可能な機能（AWS CLI、ファイル操作等）
- **モデル**: 使用するAIモデル

## 実際に作成したカスタムエージェント

今回実際に作成したカスタムエージェントは以下です。IAM Identity Center の権限管理を自動化するエージェントを作成しました。

### エージェントの設定ファイル

以下がエージェントの設定ファイルなのですが、事前に重要なポイントを説明します。必要なMCPサーバはmcp.jsonファイルに書き込んでいるためここでは指定していません。prompts は最初入れていたのですがなくても十分機能しました。

```json
{
  "$schema": "https://raw.githubusercontent.com/aws/amazon-q-developer-cli/refs/heads/main/schemas/agent-v1.json",
  "name": "idc-agent",
  "description": "IAM Identity Centerの権限付与・剥奪依頼を実行してくれるエージェント",
  "prompt": "",
  "mcpServers": {},
  "tools": ["*"],
  "allowedTools": [
    "fs_read",
    "use_aws",
    "@atlassian/get*"
  ],
  "resources": [
    "file://~/.aws/amazonq/rules/idc-agent.md"
  ],
  "model": "claude-sonnet-4.5"
}
```

### ルールの設計

上記にあるように、promptには特に指定をしていないため、resourcesで指定した`"file://~/.aws/amazonq/rules/idc-agent.md"` にルールを書いています。

エージェントには以下の役割を与えています：

1. **情報参照・分析**
   - ユーザー情報の確認
   - 権限セットの割り当て状況の確認
   - アカウント単位での権限状況の可視化

2. **権限管理操作**
   - ユーザーへの権限付与
   - ユーザーからの権限剥奪
   - 新規ユーザーの作成

### 安全性の確保

重要な操作については、以下のルールを設定しています：

- **権限削除・ユーザー削除は必ず事前確認**
- **管理系アカウントは明示的な依頼がない限り除外**
- **不明点があれば作業前に質問**

これはある意味大前提となります。エージェントに「何をしてほしいのか」を書きます。

## スムーズな操作を実現する設定のポイント

では、どのようにしてルールを定めるとスムーズにできるのかをもう少しくわしく説明します。前述したように以下のめんどくささがあります。

- 対象の環境へアクセスするためにAIと会話のラリーが必要（めんどくさい）
- どのプロファイルを使うべきか判断できないため、指定が必要（めんどくさい）

それは以下の記述で改善されました。

### 1. AWS SSO プロファイルの命名規則

`~/.aws/config` に定義するプロファイル名を統一的なルールで管理することで、エージェントが適切なプロファイルを自動判断できます。

今回の環境では、以下の命名規則を採用しています：

```
{アカウント名}-{権限レベル}
```

例：
- `xx-payer-admin` - Payerアカウント
- `xx-prod-readonly` - 本番環境のアカウント

この規則により、エージェントは依頼内容から適切なプロファイルを推測できます。もちろんそのための指示も書きます。

```
### 環境構成
- マルチOrganizations環境です
- 各OrganizationのPayerアカウントでIdentity Centerのユーザーを管理しています
- profile情報は `~/.aws/config` に記載されています（profile名: `xx-payer-admin`）
- readonlyがある場合、xx-readonlyを優先的に使用してください。権限が不足している場合はadminを使ってください
```

弊社の環境はマルチOrgになるので、Organization とアカウントのマッピングも定義しておくと完璧です。
マルチOrganization環境において、依頼内容から適切なアカウントを特定するためのマッピング情報：

```json
{
  "XOrg": {
    "account_name": "X-payer",
  },
  "YOrg": {
    "account_name": "Y-payer",
  }
  // ... 他の組織
}
```

こうすることで、「Xの環境にユーザを追加したい」といえばX-payer-admin を選択してくれました。この時点でだいぶスムーズです。そして、後述するのですがJiraの依頼内容を渡すだけで正しいPayerを判定してくれるようになります。

### 2. aws sso login の自動実行
対象のプロファイルはわかりました。次はログインです。「aws sso login --profile {適切なプロファイル名}」でログインすることをルールとしています。これがないとプロファイル指定なしで実行使用として失敗したり、aws configure を実行しろと言われたりしてめんどくさいです。

AWS環境にアクセスする前に、エージェントは自動的に以下を実行します：

```bash
aws sso login --profile {適切なプロファイル名}
```

これにより、ユーザーは認証状態を気にせず、自然言語で依頼するだけで作業を進められます。

### 3. MCP の Get コマンドをワイルドカードで許可

あと、カスタムエージェントのallowedToolsでは*もつかえます。そのため、`"@atlassian/get*"`としておくだけでget系はtrusted状態になります。確認がはいらないのは楽でよいです！

`allowedTools` で `@atlassian/get*` を指定することで、Atlassian MCP サーバーの全ての Get 系コマンドを許可しています：

```json
"allowedTools": [
  "fs_read",
  "use_aws",
  "@atlassian/get*"
]
```

これにより、以下のような操作が確認なしで実行できます：

- チケット内容の取得
- コメントの取得
- ページ内容の取得

読み取り専用の操作を許可することで、エージェントがスムーズに情報を収集し、適切な判断を下せるようになります。

## 実際の使用例

では実際の利用例のイメージです。

### Atlassian チケットからの自動処理

```bash
q chat --agent idc-agent
```

```
このチケットの対応をお願いします: https://your-company.atlassian.net/browse/TICKET-123
```

エージェントは以下を自動実行します：

1. Atlassian からチケット内容を取得
2. 必要なパラメータ（対象ユーザー、権限セット、アカウント）を抽出
3. 適切な AWS プロファイルで SSO ログイン
4. IAM Identity Center で権限操作を実行
5. 結果を報告


:::details カスタムエージェントでの作業内容の確認
[idc-agent] > これはテストです。実際に作業はせず対応すべきことをおしえてください。テスト内容は「https://genda-group.atlassian.net/browse/GT-1536 の依頼に対応してください。」です。

> テストとして、実際の依頼 GT-1536 に対応する場合の手順を説明します。

## 対応手順

### 1. 依頼内容の確認
まず、Atlassian MCPサーバを使用してチケット内容を読み取ります：
- fetch ツールで GT-1536 の詳細を取得
- または search ツールでチケットを検索


### 2. 必要情報の抽出
チケットから以下を確認：
• **申請種別**: 権限の付与 or 剥奪
• **対象会社**: GENDA / GGE / シン・コーポレーション / 映画.com / SMART EXCHANGE / Sandbox
• **対象AWSアカウント名**: どのアカウントで操作するか
• **対象ユーザー**: メールアドレス、氏名、付与する権限セット

### 3. AWS環境へのアクセス準備
対象会社に応じたプロファイルを特定：
• GENDA → genda-payer-admin
• GGE → gigo-payer-admin
• シン・コーポレーション → shin-payer-admin
• 映画.com → eiga-com-payer-admin
• SMART EXCHANGE → smx-payer-admin
• Sandbox → genda-sandbox-payer-admin

その後、aws sso login --profile <プロファイル> を実行

### 4. ユーザー存在確認
Identity Centerでユーザーが存在するか確認：
• 存在しない場合 → Confluenceのルール（https://genda-group.atlassian.net/wiki/spaces/GENDA/pages/1071612038/AWS）を確認して新規作成

### 5. 権限の付与・剥奪
申請された権限に応じて、下位権限も含めて操作：
• **AWSAdministratorAccess** → 3つすべて（Admin, PowerUser, ReadOnly）
• **AWSPowerUserAccess** → 2つ（PowerUser, ReadOnly）
• **AWSReadOnlyAccess** → 1つ（ReadOnly）

注意: 管理系アカウント（xx-payer, xx-audit, xx-log-archive）は明示的な依頼がない限り除外

### 6. 結果報告
実行した操作内容とエラーの有無を報告
:::




ちなみに、利用まえはこんな感じです。

:::details デフォルトエージェントで作業内容の確認
> これはテストです。実際に作業はせず対応すべきことをおしえてください。テスト内容は「https://genda-group.atlassian.net/browse/GT-1536 の依頼に対応してください。」です。

> テストの内容を確認しました。実際の作業を行う場合、以下の手順で対応することになります:

## 対応手順

1. Jira課題の詳細確認
   • getJiraIssue ツールを使用してGT-1536の詳細情報を取得
   • 課題の説明、要件、添付ファイル、コメントなどを確認

2. 関連情報の収集
   • 課題に関連するConfluenceページがあれば確認
   • 関連する他のJira課題やリンクがあれば確認
   • プロジェクトのコンテキストを理解

3. 要件の分析
   • 何を実装・修正する必要があるのか特定
   • 技術的な制約や依存関係を確認
   • 必要なファイルやリソースを特定

4. 実装作業
   • 必要に応じてコードの作成・修正
   • 設定ファイルの更新
   • テストの実施

5. 課題の更新
   • 作業内容をコメントで報告
   • 必要に応じてステータスを更新
   • 完了したらクローズ

実際に作業を開始する場合は、まずJira課題の内容を確認する必要があります。確認しますか?

:::



## エージェントに組み込んだ業務ルール

細かくいうと、色々とルールをくみこんでいます。

### 2. 権限付与の階層ルール

たとえばですが、弊社ではルールとして上位権限を付与する際は下位権限も自動的に付与します：

| 申請された権限 | 付与する権限セット |
|--------------|------------------|
| AWSAdministratorAccess | Administrator + PowerUser + ReadOnly |
| AWSPowerUserAccess | PowerUser + ReadOnly |
| AWSReadOnlyAccess | ReadOnly のみ |

こういったルールを記述するだけで対応してくれます。

### 3. 管理系アカウントの自動除外

以下のアカウントは、明示的な依頼がない限り権限付与対象から自動的に除外されます。それとプロダクトチームには管理系アカウントには入ってもらいたくんたいので、以下は除外するようにしています。

- `xx-payer` (Payerアカウント)
- `xx-audit` (監査アカウント)
- `xx-log-archive` (ログアーカイブアカウント)

例：「GENDA組織の全アカウントに権限付与」という依頼でも、これらの管理系アカウントは自動的にスキップされます。

これはなぜかというと、依頼の方法で「YOrgのアカウント全部」という対象の指定をされたとしても管理系のアカウントは除外して付与できるからです。地味に便利です。

## カスタムエージェントのメリット

ここまででカスタムエージェントのメリットについてまとめていきます。

### 1. コンテキストの保持

業務固有のルールや環境情報をエージェントに持たせることで、毎回説明する必要がなくなります。デフォルトエージェントだと色々と読み込むからか同じようにファイルを指定してもうまくいかないことのほうが多かったと思います。（主観）

### 2. 複数サービスの連携

Atlassian、AWS、ファイルシステムなど、複数のサービスをシームレスに連携できます。これはデフォルトエージェントでもそうですが、必要なものだけを用意することで精度が高くなる印象です（主観）

### 4. 属人化の解消

手順をエージェントに組み込むことで、誰でも同じ品質で作業を実行できます。別で説明したいですが、設定ファイルをGitHubで管理するとみんなで作成したり編集できます。ただ、再現性についてはもしかしたら注意が必要かもしれません。今のところ問題おきていないです。

### 5. 依頼の「あいまいさ」を許容できる

従来の自動化では、入力のバリデーションを厳密に実装しないとうまくいきませんでした。しかし、カスタムエージェントは自然言語を理解するため、以下のようなあいまいな表現にも対応できます。特に、その頻度から管理用のコードやアーキテクチャを管理しなくてもよいのでトータルコストは下がったように思います。

**アカウントの指定方法の多様性**
- 「genda-production アカウント」
- 「543534183444」（アカウントID）
- 「本番環境のアカウント」

**範囲指定の柔軟性**
- 「GENDA組織の全アカウントに権限付与」
- 「開発環境すべて」
- 「本番以外のアカウント」

エージェントは文脈から意図を理解し、適切なアカウントを特定します。

現状の自動承認システムでは、このようなあいまいな記述には対応できず、厳密なフォーマットが必要です。バリデーションロジックを複雑にするよりも、AIの理解力を活用することで、ユーザーフレンドリーな運用が実現できます。

### 6. 頻度の低い作業の半自動化に最適

完全自動化するほど頻度は高くないが、手作業では手間がかかる作業に最適です：

- **完全自動化の課題**：開発・保守コストが高く、頻度が低いと費用対効果が悪い
- **手作業の課題**：手順が複雑で、ミスが発生しやすい
- **エージェントによる半自動化**：
  - 複雑な手順はエージェントが実行
  - 重要な判断は人間が確認
  - 開発コストは最小限

例えば、月に数回程度の権限付与作業であれば、完全自動化システムを構築するよりも、エージェントに依頼して確認しながら進める方が効率的です。

## まとめ

Amazon Q Developer CLI のカスタムエージェント機能を活用することで、AWS運用業務を大幅に効率化できます。

特に以下のような業務に有効です：

- 定型的だが手順が多い作業
- 複数のサービスを跨ぐ作業
- 安全性の確保が重要な作業
- ドキュメントやルールが頻繁に更新される作業

ぜひ、あなたの業務でもカスタムエージェントを活用してみてください。
