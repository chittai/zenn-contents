---
title: "Amazon Q Developer CLIのカスタムエージェントでAWS運用を自動化する"
emoji: "🤖"
type: "tech"
topics: ["AWS", "AmazonQ", "IAM", "自動化"]
published: false
---

AWS環境の運用において、IAM Identity Centerのユーザー管理や権限付与は日常的に発生する作業です。しかし、マルチアカウント・マルチOrganization環境では、適切なアカウントへのアクセス、権限セットの確認、安全な操作の実行など、多くの手順を踏む必要があります。

本記事では、**Amazon Q Developer CLI のカスタムエージェント機能**を活用して、これらの運用業務を効率化する方法を紹介します。

## この記事で伝えたいこと

- **Amazon Q Developer CLI を使えば、AWS環境に簡単にアクセスできる**
- **カスタムエージェントにコンテキストを渡すことで、AWS操作が必要な業務を効率的に進められる**

## Amazon Q Developer CLI とは

Amazon Q Developer CLI は、ターミナル上で動作するAIアシスタントです。自然言語での指示により、以下のような操作が可能です：

- ファイルの読み書き
- AWS CLI の実行
- 外部サービス（Atlassian等）との連携
- カスタムロジックの実行

## カスタムエージェントとは

カスタムエージェントは、特定の業務に特化したAIアシスタントを作成できる機能です。以下の要素で構成されます：

- **プロンプト**: エージェントの役割と振る舞いを定義
- **リソース**: 参照すべきドキュメントやルール
- **ツール**: 使用可能な機能（AWS CLI、ファイル操作等）
- **モデル**: 使用するAIモデル

## 実際に作成したカスタムエージェント

IAM Identity Center の権限管理を自動化するエージェントを作成しました。

### エージェントの設定ファイル

```json
{
  "$schema": "https://raw.githubusercontent.com/aws/amazon-q-developer-cli/refs/heads/main/schemas/agent-v1.json",
  "name": "idc-agent",
  "description": "",
  "prompt": "file://./prompts/idc-agent.md",
  "mcpServers": {},
  "tools": ["*"],
  "allowedTools": [
    "fs_read",
    "use_aws",
    "@atlassian/get*"
  ],
  "resources": [
    "file://~/.aws/amazonq/rules/idc-agent.md"
  ],
  "model": "claude-sonnet-4.5"
}
```

### プロンプトの設計

エージェントには以下の役割を与えています：

1. **情報参照・分析**
   - ユーザー情報の確認
   - 権限セットの割り当て状況の確認
   - アカウント単位での権限状況の可視化

2. **権限管理操作**
   - ユーザーへの権限付与
   - ユーザーからの権限剥奪
   - 新規ユーザーの作成

### 安全性の確保

重要な操作については、以下のルールを設定しています：

- **権限削除・ユーザー削除は必ず事前確認**
- **管理系アカウントは明示的な依頼がない限り除外**
- **不明点があれば作業前に質問**

### 詳細ルールの外部化

環境固有の情報（アカウントマッピング、権限ルール等）は、別ファイル（`~/.aws/amazonq/rules/idc-agent.md`）に記載し、`resources` で参照させています。

これにより、以下のメリットがあります：

- プロンプトをシンプルに保てる
- 環境情報の更新が容易
- 機密情報の管理が明確

## スムーズな操作を実現する設定のポイント

### 1. AWS SSO プロファイルの命名規則

`~/.aws/config` に定義するプロファイル名を統一的なルールで管理することで、エージェントが適切なプロファイルを自動判断できます。

今回の環境では、以下の命名規則を採用しています：

```
{組織名}-{アカウント名}-{権限レベル}
```

例：
- `genda-payer-admin` - GENDA組織のPayerアカウントの管理者権限
- `gigo-production-readonly` - GGE組織のProductionアカウントの読み取り専用権限
- `shin-audit-admin` - シン・コーポレーション組織のAuditアカウントの管理者権限

この規則により、エージェントは依頼内容から適切なプロファイルを推測できます。

### 2. aws sso login の自動実行

AWS環境にアクセスする前に、エージェントは自動的に以下を実行します：

```bash
aws sso login --profile {適切なプロファイル名}
```

これにより、ユーザーは認証状態を気にせず、自然言語で依頼するだけで作業を進められます。

### 3. MCP の Get コマンドをワイルドカードで許可

`allowedTools` で `@atlassian/get*` を指定することで、Atlassian MCP サーバーの全ての Get 系コマンドを許可しています：

```json
"allowedTools": [
  "fs_read",
  "use_aws",
  "@atlassian/get*"
]
```

これにより、以下のような操作が確認なしで実行できます：

- チケット内容の取得
- コメントの取得
- ページ内容の取得

読み取り専用の操作を許可することで、エージェントがスムーズに情報を収集し、適切な判断を下せるようになります。

## エージェントに組み込んだ業務ルール

詳細ルールファイル（`~/.aws/amazonq/rules/idc-agent.md`）には、以下のような業務固有のルールを定義しています。

### 1. Organization とアカウントのマッピング

マルチOrganization環境において、依頼内容から適切なアカウントを特定するためのマッピング情報：

```json
{
  "GENDA (genda-)": {
    "account_id": "543534183444",
    "account_name": "genda-payer",
    "role_name": "SlackIAMWorkflowRole"
  },
  "GGE (gigo-)": {
    "account_id": "654180281680",
    "account_name": "gigo-payer",
    "role_name": "SlackIAMWorkflowRole"
  }
  // ... 他の組織
}
```

### 2. 権限付与の階層ルール

権限セットには階層があり、上位権限を付与する際は下位権限も自動的に付与します：

| 申請された権限 | 付与する権限セット |
|--------------|------------------|
| AWSAdministratorAccess | Administrator + PowerUser + ReadOnly |
| AWSPowerUserAccess | PowerUser + ReadOnly |
| AWSReadOnlyAccess | ReadOnly のみ |

このルールにより、ユーザーは適切な権限の組み合わせを自動的に取得できます。

### 3. 管理系アカウントの自動除外

以下のアカウントは、明示的な依頼がない限り権限付与対象から自動的に除外されます：

- `xx-payer` (Payerアカウント)
- `xx-audit` (監査アカウント)
- `xx-log-archive` (ログアーカイブアカウント)

例：「GENDA組織の全アカウントに権限付与」という依頼でも、これらの管理系アカウントは自動的にスキップされます。

### 4. 新規ユーザー作成のルール参照

対象ユーザーが存在しない場合、エージェントは Confluence から新規ユーザー作成のルールを自動的に取得し、それに従ってユーザーを作成します。

これにより、最新のルールに常に準拠した運用が可能になります。

## 実際の使用例

### 1. Atlassian チケットからの自動処理

```bash
q chat --agent idc-agent
```

```
このチケットの対応をお願いします: https://your-company.atlassian.net/browse/TICKET-123
```

エージェントは以下を自動実行します：

1. Atlassian からチケット内容を取得
2. 必要なパラメータ（対象ユーザー、権限セット、アカウント）を抽出
3. 適切な AWS プロファイルで SSO ログイン
4. IAM Identity Center で権限操作を実行
5. 結果を報告

### 2. 権限状況の確認

```
genda-production アカウントの権限状況を確認して
```

エージェントは権限の割り当て状況を整理して、わかりやすく表形式で提示します。

## カスタムエージェントのメリット

### 1. コンテキストの保持

業務固有のルールや環境情報をエージェントに持たせることで、毎回説明する必要がなくなります。

### 2. 安全な操作

事前確認のルールや除外ルールを組み込むことで、誤操作を防止できます。

### 3. 複数サービスの連携

Atlassian、AWS、ファイルシステムなど、複数のサービスをシームレスに連携できます。

### 4. 属人化の解消

手順をエージェントに組み込むことで、誰でも同じ品質で作業を実行できます。

### 5. 依頼の「あいまいさ」を許容できる

従来の自動化では、入力のバリデーションを厳密に実装する必要がありました。しかし、カスタムエージェントは自然言語を理解するため、以下のようなあいまいな表現にも対応できます：

**アカウントの指定方法の多様性**
- 「genda-production アカウント」
- 「543534183444」（アカウントID）
- 「本番環境のアカウント」

**範囲指定の柔軟性**
- 「GENDA組織の全アカウントに権限付与」
- 「開発環境すべて」
- 「本番以外のアカウント」

エージェントは文脈から意図を理解し、適切なアカウントを特定します。

現状の自動承認システムでは、このようなあいまいな記述には対応できず、厳密なフォーマットが必要です。バリデーションロジックを複雑にするよりも、AIの理解力を活用することで、ユーザーフレンドリーな運用が実現できます。

### 6. 頻度の低い作業の半自動化に最適

完全自動化するほど頻度は高くないが、手作業では手間がかかる作業に最適です：

- **完全自動化の課題**：開発・保守コストが高く、頻度が低いと費用対効果が悪い
- **手作業の課題**：手順が複雑で、ミスが発生しやすい
- **エージェントによる半自動化**：
  - 複雑な手順はエージェントが実行
  - 重要な判断は人間が確認
  - 開発コストは最小限

例えば、月に数回程度の権限付与作業であれば、完全自動化システムを構築するよりも、エージェントに依頼して確認しながら進める方が効率的です。

## まとめ

Amazon Q Developer CLI のカスタムエージェント機能を活用することで、AWS運用業務を大幅に効率化できます。

特に以下のような業務に有効です：

- 定型的だが手順が多い作業
- 複数のサービスを跨ぐ作業
- 安全性の確保が重要な作業
- ドキュメントやルールが頻繁に更新される作業

ぜひ、あなたの業務でもカスタムエージェントを活用してみてください。
